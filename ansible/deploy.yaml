---
- name: Deploy Aculei Backend
  hosts: hosts
  vars:
    deploy_user: "{{ username | default(ansible_user) }}"
    ghcr_username: "{{ lookup('env', 'GHCR_USERNAME') }}"
    gh_token: "{{ lookup('env', 'GH_TOKEN') }}"
    mongo_uri: "{{ lookup('env', 'MONGO_URI') }}"
    image_name: "ghcr.io/aculei/aculei-be:main"
    redis_host: "redis:6379"
    project_dir: "/{{ deploy_user }}"

  tasks:
    - name: Login to ghcr.io
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ ghcr_username }}"
        password: "{{ gh_token }}"

    - name: Deploy containers with docker compose
      community.docker.docker_compose_v2:
        project_src: "{{ project_dir }}"
        state: present
        build: true
        environment:
          REDIS_HOST: "{{ redis_host }}"
          MONGO_URI: "{{ mongo_uri }}"
          GIN_MODE: "release"

    - name: Ping backend to verify deployment
      ansible.builtin.uri:
        url: http://127.0.0.1:8888/health
        method: GET
        status_code: 200

- name: Cleanup unused Docker resources
  hosts: hosts
  become: true
  tasks:
    - name: Clean up unused Docker resources
      community.docker.docker_prune:
        images: true
        volumes: true
        networks: true
        builder_cache: true
