---
- name: Deploy Aculei Backend
  hosts: myhosts
  vars:
    deploy_user: "{{ username | default(ansible_user) }}"
    ghcr_username: "{{ lookup('env', 'GHCR_USERNAME') }}"
    gh_token: "{{ lookup('env', 'GH_TOKEN') }}"
    mongo_uri: "{{ lookup('env', 'MONGO_URI') }}"
    image_name: "ghcr.io/aculei/aculei-be:main"

  tasks:
    - name: Login to ghcr.io
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ ghcr_username }}"
        password: "{{ gh_token }}"
    - name: Stop and remove existing container
      shell: docker rm $(docker stop $(docker ps -a -q --filter ancestor={{ image_name }} --format="{{ '{{.ID}}' }}"))
    - name: Update backend container
      community.docker.docker_container:
        name: aculei_backend
        image: "{{ image_name }}"
        state: started
        restart_policy: on-failure
        ports:
          - "8888:8888"
        env:
          GIN_MODE: "release"
          MONGO_URI: "{{ mongo_uri }}"
    - name: Ping backend to verify deployment
      ansible.builtin.uri:
        url: http://127.0.0.1:8888/health
        method: GET
        status_code: 200

- name: Cleanup unused Docker resources
  hosts: myhosts
  become: true
  tasks:
    - name: Clean up unused Docker resources
      community.docker.docker_prune:
        images: true
        volumes: true
        networks: true
        builder_cache: true
